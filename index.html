<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Test Carousel - Partial Visible (Optimized)</title>
  <style>
    /* 全局 */
    body {
      margin: 0; 
      padding: 0; 
      background: #f0f0f0;
      font-family: Arial, sans-serif;
    }
    h2 {
      text-align: center;
      margin: 20px 0;
    }

    /* 轮播容器：固定高度 495px */
    .demo1-carousel-container {
      position: relative;
      width: 100%;
      height: 495px;
      overflow: hidden;
      margin: 0 auto;
      display: flex;
      justify-content: center;
      align-items: center;
      box-sizing: border-box;
    }
    .demo1-carousel-track {
      display: flex;
      gap: 15px; /* 图片之间间隔15px */
      transition: transform 0.5s ease-in-out;
      align-items: center;
    }
    /* 每个幻灯片 */
    .demo1-carousel-slide {
      flex: 0 0 auto;
      width: 100%;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    /* 图片：占满幻灯片区域，高度 495px => cover */
    .demo1-carousel-slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
      display: block;
    }

    /* 小圆点 */
    .demo1-carousel-dots-container {
      text-align: center;
      margin-top: 10px;
    }
    .demo1-carousel-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      background: #ccc;
      border-radius: 50%;
      margin: 0 5px;
      cursor: pointer;
    }
    .demo1-carousel-dot.active {
      background: #007BFF;
    }
  </style>
</head>
<body>
  <h2>Test Carousel - Partial Visible (Optimized)</h2>

  <!-- 轮播容器 -->
  <div class="demo1-carousel-container">
    <div class="demo1-carousel-track">
      <!-- 幻灯片1 -->
      <div class="demo1-carousel-slide">
        <img src="Lv-Se-qing-cai.png" alt="Slide1">
      </div>
      <!-- 幻灯片2 -->
      <div class="demo1-carousel-slide">
        <img src="Two baskets of vegetables.png" alt="Slide2">
      </div>
      <!-- 幻灯片3 -->
      <div class="demo1-carousel-slide">
        <img src="合作伙伴Logo1.png" alt="Slide3">
      </div>
      <!-- 幻灯片4 -->
      <div class="demo1-carousel-slide">
        <img src="合作伙伴Logo2.png" alt="Slide4">
      </div>
    </div>
  </div>

  <!-- 小圆点容器 -->
  <div class="demo1-carousel-dots-container">
    <span class="demo1-carousel-dot"></span>
    <span class="demo1-carousel-dot"></span>
    <span class="demo1-carousel-dot"></span>
    <span class="demo1-carousel-dot"></span>
  </div>

  <script>
  function initdemo1CarouselTrack() {
    const container = document.querySelector(".demo1-carousel-container");
    const track = document.querySelector(".demo1-carousel-track");
    const slides = Array.from(document.querySelectorAll(".demo1-carousel-slide"));
    const dots = Array.from(document.querySelectorAll(".demo1-carousel-dot"));

    if (!container || !track || slides.length === 0 || !dots.length) return;

    // 1) 真实幻灯片数量 4
    const totalReal = 4;
    const uniqueSlides = slides.slice(0, totalReal);

    uniqueSlides.forEach((slide, i) => {
      slide.setAttribute("data-index", i);
    });

    // 2) 克隆首尾 => 无缝循环
    const firstSlide = uniqueSlides[0];
    const lastSlide  = uniqueSlides[totalReal - 1];
    const firstClone = firstSlide.cloneNode(true);
    const lastClone  = lastSlide.cloneNode(true);
    track.insertBefore(lastClone, track.firstChild);
    track.appendChild(firstClone);

    const allSlides = Array.from(track.querySelectorAll(".demo1-carousel-slide"));
    const totalSlidesWithClones = allSlides.length; // 6
    let currentIndex = 1;  // 初始指向真实第1张
    let isAnimating  = false;

    /**
     * 3) getSlideWidth():
     *   - 移动端 => (0.85 * window.innerWidth) + 15
     *   - 桌面端 => (containerWidth * 0.8) + 15
     *   (这样保证桌面端也比容器小，能左右露出)
     */
    function getSlideWidth() {
      const containerWidth = container.getBoundingClientRect().width;
      if (window.innerWidth <= 768) {
        let cardWidth = Math.floor(window.innerWidth * 0.85);
        let gap = 15;
        return cardWidth + gap;
      } else {
        let gap = 15;
        // 强制让每张slide占80%容器宽 + 15 => 确保左右漏出
        return Math.floor(containerWidth * 0.8) + gap;
      }
    }

    /**
     * 4) updateCarousel():
     *    居中偏移 => offset = -(currentIndex * slideWidth) + (containerWidth - slideWidth)/2
     */
    function updateCarousel() {
      const slideWidth = getSlideWidth();
      const containerWidth = container.getBoundingClientRect().width;
      const offset = -(currentIndex * slideWidth) + (containerWidth - slideWidth)/2;
      track.style.transform = `translateX(${offset}px)`;

      // 更新小圆点
      let dotIndex;
      if (currentIndex === 0) {
        dotIndex = totalReal - 1;
      } else if (currentIndex === totalSlidesWithClones - 1) {
        dotIndex = 0;
      } else {
        dotIndex = currentIndex - 1;
      }
      dots.forEach((dot, i) => {
        dot.classList.toggle("active", i === dotIndex);
      });
    }

    // 5) next/prev/jump
    function nextSlide() {
      if (isAnimating) return;
      isAnimating = true;
      currentIndex++;
      track.style.transition = "transform 0.5s ease-in-out";
      updateCarousel();
    }
    function prevSlide() {
      if (isAnimating) return;
      isAnimating = true;
      currentIndex--;
      track.style.transition = "transform 0.5s ease-in-out";
      updateCarousel();
    }
    function jumpToSlide(index) {
      if (isAnimating) return;
      isAnimating = true;
      currentIndex = index + 1;
      track.style.transition = "transform 0.5s ease-in-out";
      updateCarousel();
    }

    // 6) dots点击
    dots.forEach((dot, i) => {
      dot.addEventListener("click", () => {
        jumpToSlide(i);
        resetInterval();
      });
    });

    // 7) transitionend => 无缝循环
    track.addEventListener("transitionend", () => {
      if (currentIndex === totalSlidesWithClones - 1) {
        track.style.transition = "none";
        currentIndex = 1;
        updateCarousel();
        void track.offsetWidth;
        track.style.transition = "transform 0.5s ease-in-out";
      }
      if (currentIndex === 0) {
        track.style.transition = "none";
        currentIndex = totalReal;
        updateCarousel();
        void track.offsetWidth;
        track.style.transition = "transform 0.5s ease-in-out";
      }
      isAnimating = false;
    });

    // 8) auto
    let interval = setInterval(nextSlide, 5000);
    function resetInterval() {
      clearInterval(interval);
      interval = setInterval(nextSlide, 5000);
    }

    // 9) 初始化
    track.style.transition = "none";
    updateCarousel();
    setTimeout(() => {
      track.style.transition = "transform 0.5s ease-in-out";
    }, 50);

    // 10) 点击：中间图 => 链接, 左右图 => 切换(若需要)
    allSlides.forEach(slide => {
      slide.addEventListener("click", (e) => {
        if (slide.classList.contains("active")) {
          // 中间图 => 不阻止
        } else if (slide.classList.contains("next")) {
          e.preventDefault();
          nextSlide();
          resetInterval();
        } else if (slide.classList.contains("prev")) {
          e.preventDefault();
          prevSlide();
          resetInterval();
        }
      });
    });

    // 11) 触摸滑动
    let startX = 0;
    let isSwiping = false;
    container.addEventListener('touchstart', (e) => {
      if (isAnimating) return;
      isSwiping = true;
      startX = e.touches[0].clientX;
    });
    container.addEventListener('touchmove', (e) => {
      // ...
    });
    container.addEventListener('touchend', (e) => {
      if (!isSwiping) return;
      let endX = e.changedTouches[0].clientX;
      let distance = endX - startX;
      isSwiping = false;
      if (Math.abs(distance) > 50) {
        if (distance < 0) {
          nextSlide();
        } else {
          prevSlide();
        }
        resetInterval();
      }
    });
  }

  // 启动
  window.addEventListener('load', () => {
    initdemo1CarouselTrack();
  });
  </script>
</body>
</html>
